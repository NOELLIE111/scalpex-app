# Рабочий процесс с venv и pip

# 1. Активация виртуального окружения

# Способ А (Рекомендуется): В терминале Git Bash / MINGW64
source venv/Scripts/activate

# Способ Б: В терминале PowerShell
# Сначала нужно один раз выполнить команду, чтобы разрешить запуск скриптов:
# Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
# После этого для активации используйте:
# .\venv\Scripts\Activate.ps1

# Для выхода из окружения используйте команду `deactivate`.

# 2. Запуск компонентов для разработки
# (нужно находиться в активированном окружении)

# Способ 1: Вручную, в двух разных терминалах (рекомендуется для отладки)
# ВАЖНО: Обе команды нужно запускать из корневой папки проекта (где лежат папки client, server, managers).

# В первом терминале (из корня проекта):
python -m server.run_bot

# Во втором терминале (из корня проекта):
python -m client.main

# Способ 2: Автоматически, одной командой (удобно для быстрого старта)

# Для Windows (откроет два новых окна):
scripts\start-dev.bat

# Для Linux/macOS/Git Bash (запустит все в одном окне):
./scripts/start-dev.sh

---

# Работа с библиотеками

# 1. Установить новую библиотеку (например, ccxt)
pip install ccxt
# После установки, не забудьте обновить файл зависимостей:
pip freeze > requirements.txt

# 2. Установить новую библиотеку для разработки (например, pre-commit)
pip install pre-commit
# После установки, обновите dev-зависимости:
pip freeze > requirements-dev.txt

# 2.1 Установить KivyMD для красивого интерфейса
# Используем последнюю dev-версию, как рекомендуют разработчики
pip install --upgrade --no-cache-dir "https://github.com/kivymd/KivyMD/archive/master.zip"
# И обновить основной файл зависимостей:
pip freeze > requirements.txt

# 2.2 Установить Watchdog для горячей перезагрузки
pip install watchdog
# И обновить dev-зависимости:
pip freeze > requirements-dev.txt

# 2.3 Установить HTTPX для асинхронных запросов
pip install httpx
# И обновить основной файл зависимостей:
pip freeze > requirements.txt

# 2.4 Установить Uvicorn для запуска FastAPI сервера
pip install uvicorn
# И обновить основной файл зависимостей:
pip freeze > requirements.txt

# 3. Установить все зависимости из файлов (например, после git pull)
pip install -r requirements.txt -r requirements-dev.txt

# 4. Удалить библиотеку (например, requests)
pip uninstall requests
# После удаления, не забудьте обновить файл зависимостей:
pip freeze > requirements.txt

---

# Что делать, если `git commit` не проходит? (Pre-commit hooks)

Если при попытке сделать `git commit` вы видите ошибку и сообщение `...Failed`, это значит, что сработали **pre-commit хуки** — автоматические проверки качества кода. **Это хорошо!** Они не дают "грязному" коду попасть в репозиторий.

**Ваши действия:**

1.  **Прочитайте ошибку.** В выводе терминала будет точно указан файл и номер строки, где найдена проблема (например, `E402 Module level import not at top of file`).
2.  **Исправьте код** в указанном файле в соответствии с ошибкой.
3.  **Снова добавьте исправленные файлы** в коммит:
    ```
    git add .
    ```
4.  **Повторите попытку коммита:**
    ```
    git commit -m "feat: Описание новой функциональности"
    ```

Теперь проверки должны пройти успешно.

# Мой рабочий цикл (отправка изменений)

# 1. Подготовить все измененные файлы
git add .

# 2. Сделать локальное сохранение (коммит) с описанием
git commit -m "feat: Описание новой функциональности"

# 3. Отправить свои коммиты на GitHub
git push

---

# Получение изменений от других

# 1. Скачать все последние изменения с GitHub
git pull
# 2. После git pull, если коллеги обновили библиотеки, выполнить:
pip install -r requirements.txt
pip install -r requirements-dev.txt

---

# Сборка финального .exe файла для клиента

# 1. **ВАЖНО:** Сначала перейдите в папку клиента. Команда не сработает из корневой папки.
cd client

# 2. Установите PyInstaller и хуки для Kivy (если они еще не установлены в вашем venv)
pip install pyinstaller pyinstaller-hooks-contrib

# 3. Запустите сборку. Эта команда:
#    --name ScalpEX: Задаст имя файла.
#    --onefile: Упакует все в один .exe.
#    --windowed: Уберет черное окно консоли при запуске.
#    --add-data "main_screen.kv;.": Добавит файл интерфейса внутрь .exe.
pyinstaller --name ScalpEX --onefile --windowed --add-data "main_screen.kv;." main.py

# 4. Готовый файл будет лежать в папке client/dist/

---

# Сборка приложения для Android (.apk / .aab)

**ВАЖНО:** На Windows сборка Android-приложений с помощью Buildozer требует **Windows Subsystem for Linux (WSL)**. Запуск `buildozer` напрямую в CMD или PowerShell не сработает и вызовет ошибку `Unknown command/target android`.

### Шаг 1: Установка и настройка WSL (делается один раз)

1.  Откройте **PowerShell от имени администратора** и выполните команду:
    ```powershell
    wsl --install
    ```
2.  Перезагрузите компьютер, если потребуется.
3.  Найдите и запустите **Ubuntu** в меню "Пуск". При первом запуске вам будет предложено создать имя пользователя и пароль для вашей Linux-среды.

### Шаг 2: Настройка окружения внутри WSL

**ВАЖНО:** Всегда выполняйте эти команды от имени вашего обычного пользователя (которого вы создали при первом запуске WSL), а не от `root`. Используйте `sudo` для команд, требующих прав администратора (например, `sudo apt install ...`). Запуск `buildozer` от имени `root` может привести к ошибкам.

Все последующие команды выполняются в терминале **Ubuntu (WSL)**.

1.  **Установите системные зависимости**, необходимые для Buildozer:
    ```bash
    sudo apt update
    sudo apt install -y build-essential git zip unzip openjdk-17-jdk python3-pip python3-venv autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
    ```
2.  **Перейдите в папку вашего проекта.** Ваши диски Windows доступны по пути `/mnt/`.
    ```bash
    # Замените 57kir на ваше имя пользователя Windows
    cd /mnt/c/Users/57kir/Desktop/ScalpEX_app/ScalpEX_app
    ```
3.  **Создайте новое виртуальное окружение** (оно будет отдельным от вашего Windows venv):
    ```bash
    python3 -m venv venv-wsl
    source venv-wsl/bin/activate
    ```
4.  **Установите все Python-зависимости** вашего проекта в это новое окружение:
    ```bash
    pip install --upgrade pip
    pip install setuptools # Важно для Python 3.12+, так как buildozer требует удаленный модуль distutils
    pip install cython # Cython необходим для компиляции Python в нативный код
    pip install -r requirements.txt
    pip install buildozer
    ```

### Шаг 3: Запуск сборки

Находясь в папке проекта внутри терминала WSL и с активированным окружением `venv-wsl`, выполните команду сборки:

```bash
# Сборка тестового .apk файла. Первый запуск будет очень долгим!
buildozer android debug

# Сборка релизного .aab файла для Google Play
# buildozer android release
```

Готовый файл `.apk` или `.aab` появится в папке `bin/` вашего проекта.
